import{NextResponse as e}from"next/server";import{COOKIE_LOCALE_NAME as t,COOKIE_SAME_SITE as a,COOKIE_MAX_AGE as o,HEADER_LOCALE_NAME as n}from"../shared/constants.js";import{matchesPathname as l}from"../shared/utils.js";import r from"./getAlternateLinksHeaderValue.js";import s from"./resolveLocale.js";import{isLocaleSupportedOnDomain as i,getNormalizedPathname as c,getPathnameLocale as d,getInternalTemplate as f,formatTemplatePathname as u,getPathWithSearch as h,getBestMatchingDomain as m,applyBasePath as v}from"./utils.js";function x(x){const p=function(e){var t,a,o;return{...e,alternateLinks:null===(t=e.alternateLinks)||void 0===t||t,localePrefix:null!==(a=e.localePrefix)&&void 0!==a?a:"always",localeDetection:null===(o=e.localeDetection)||void 0===o||o}}(x);return function(x){var P,U;const g=decodeURI(x.nextUrl.pathname),{domain:L,locale:k}=s(p,x.headers,x.cookies,g),w=p.localeDetection&&(null===(P=x.cookies.get(t))||void 0===P?void 0:P.value)!==k,b=L?L.defaultLocale===k:k===p.defaultLocale,j=(null===(U=p.domains)||void 0===U?void 0:U.filter((e=>i(k,e))))||[],y=null!=p.domains&&!L;function D(t){const a=new URL(t,x.url);return x.nextUrl.basePath&&(a.pathname=v(a.pathname,x.nextUrl.basePath)),e.rewrite(a,function(){const e=new Headers(x.headers);return e.set(n,k),{request:{headers:e}}}())}function R(t,a){const o=new URL(t,x.url);if(j.length>0&&!a){const e=m(L,k,j);e&&(a=e.domain,e.defaultLocale===k&&"as-needed"===p.localePrefix&&o.pathname.startsWith("/".concat(k))&&(o.pathname=c(o.pathname,p.locales)))}var n,l;a&&(o.host=a,x.headers.get("x-forwarded-host")&&(o.protocol=null!==(n=x.headers.get("x-forwarded-proto"))&&void 0!==n?n:x.nextUrl.protocol,o.port=null!==(l=x.headers.get("x-forwarded-port"))&&void 0!==l?l:""));return x.nextUrl.basePath&&(o.pathname=v(o.pathname,x.nextUrl.basePath)),e.redirect(o.toString())}const q=c(g,p.locales),A=d(g,p.locales),H=null!=A;let S,z,I=g;if(p.pathnames){let e;if([e,z]=f(p.pathnames,q,k),z){const t=p.pathnames[z],a="string"==typeof t?t:t[k];if(l(a,q))I=u(q,a,z,A);else{let o;o=e?"string"==typeof t?t:t[e]:z;const n=!H&&b||"never"===p.localePrefix?void 0:k;S=R(h(u(q,o,a,n),x.nextUrl.search))}}}if(!S)if("/"===I){const e=h("/".concat(k),x.nextUrl.search);S="never"===p.localePrefix||b&&"as-needed"===p.localePrefix?D(e):R(e)}else{const e=h(I,x.nextUrl.search);if(H){const t=h(q,x.nextUrl.search);if("never"===p.localePrefix)S=R(t);else if(A===k)if(b&&"as-needed"===p.localePrefix)S=R(t);else if(p.domains){const a=m(L,A,j);S=(null==L?void 0:L.domain)===(null==a?void 0:a.domain)||y?D(e):R(t,null==a?void 0:a.domain)}else S=D(e);else S=R("/".concat(k).concat(t))}else S="never"===p.localePrefix||b&&("as-needed"===p.localePrefix||p.domains)?D("/".concat(k).concat(e)):R("/".concat(k).concat(e))}var V;(w&&S.cookies.set(t,k,{path:x.nextUrl.basePath||void 0,sameSite:a,maxAge:o}),"never"!==p.localePrefix&&p.alternateLinks&&p.locales.length>1)&&S.headers.set("Link",r({config:p,localizedPathnames:null!=z?null===(V=p.pathnames)||void 0===V?void 0:V[z]:void 0,request:x,resolvedLocale:k}));return S}}export{x as default};
